rule:
  meta:
    name: patch Antimalware Scan Interface function
    namespace: anti-analysis/anti-av
    authors:
      - jakub.jozwiak@mandiant.com
    scope: function
    att&ck:
      - Defense Evasion::Impair Defenses::Disable or Modify Tools [T1562.001]
    mbc:
      - Defense Evasion::Disable or Evade Security Tools [F0004]
    references:
      - https://fluidattacks.com/blog/amsi-bypass/
    examples:
      - edb92795c06a2bde47e652639327253a1148ee675ba2f0d1d9ac8690ef1820b1:0x14001126C
  features:
    - and:
      - match: link function at runtime on Windows
      - or:
        - api: kernel32.VirtualProtect
        - api: kernel32.VirtualProtectEx
        - api: ntdll.NtProtectVirtualMemory
        - api: ZwProtectVirtualMemory
        - string: "VirtualProtect"
        - string: "VirtualProtectEx"
        - string: "NtProtectVirtualMemory"
        - string: "ZwProtectVirtualMemory"
      - or:
        - string: "AmsiScanBuffer"
        - string: "AmsiScanString"
      - optional:
        - match: write process memory
        - string: "amsi.dll"
